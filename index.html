<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Europa Preiskarte</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body {
  height:100%;
  margin:0;
}

#map {
  width:100%;
  height:100%;
}

/* Deine normalen Boxen (Legende etc.) */
.box{
  position:absolute;
  background:#fff;
  padding:8px 10px;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
  font:14px/1.3 system-ui,Arial,sans-serif;
  z-index:1000;
}
</style>
</head>

<body>

<div id="map"></div>

<script>

// ==============================
// KARTE INITIALISIEREN
// ==============================

const map = L.map('map', {
  preferCanvas:true
}).setView([51,10],5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap'
}).addTo(map);


// ==============================
// GEO CACHE OPTIONAL
// ==============================

async function loadGeoCache(){
  try{
    const res = await fetch("./geo_cache.json", {cache:"no-store"});
    if(!res.ok) throw new Error();
    return await res.json();
  }catch(e){
    return {}; // kein Fehler mehr, wenn Datei fehlt
  }
}


// ==============================
// FIRMEN LADEN
// ==============================

async function loadFirmen(){

  const geoCache = await loadGeoCache();

  Papa.parse("FIRMEN.csv", {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:function(results){

      results.data.forEach(row=>{

        let lat = parseFloat(row.lat);
        let lon = parseFloat(row.lon);

        if((!lat || !lon) && geoCache[row.Adresse]){
          lat = geoCache[row.Adesse]?.lat;
          lon = geoCache[row.Adresse]?.lon;
        }

        if(lat && lon){
          const marker = L.circleMarker([lat,lon],{
            radius:6,
            color:"#0055ff",
            fillOpacity:0.8
          }).addTo(map);

          marker.bindPopup(`
            <b>${row.Name || "Firma"}</b><br>
            ${row.Adresse || ""}
          `);
        }

      });

    }
  });
}


// ==============================
// START
// ==============================

loadFirmen();

</script>
</body>
</html>
