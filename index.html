<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Europa Preiskarte ‚Äì Pellets / Streusalz</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0}#map{height:100%;width:100%}
.box{position:absolute;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial;z-index:2000}
.search{top:12px;right:12px;width:260px}
.legend{bottom:12px;right:12px;min-width:180px;z-index:3000}
.cert{bottom:12px;left:12px;z-index:2500}
.box input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle}
.search input,.search select{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;box-sizing:border-box}
.search .row{margin-top:8px}
.cert hr{border:none;height:1px;background:#eee;margin:6px 0}

.dd{position:relative;display:block;width:100%;margin-top:8px}
.ddbtn{width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box}
.ddbtn:after{content:"‚ñæ";float:right;opacity:.6}
.ddm{position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:4000;display:none;min-width:160px;max-height:260px;overflow:auto;padding:6px 8px;box-sizing:border-box}
.ddm label{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;margin:0;white-space:nowrap}

.hidden{display:none!important}

/* Debug */
.debugbox{
  position:absolute;left:12px;top:12px;z-index:9999;
  background:#111;color:#fff;font:12px/1.3 system-ui,Arial;
  padding:8px 10px;border-radius:10px;max-width:520px;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
  opacity:.92
}
.debugbox b{display:block;margin-bottom:4px}
.debugbox .ok{color:#76ff7a}
.debugbox .bad{color:#ff6b6b}
.debugbox .btn{
  display:inline-block;margin-top:6px;
  border:1px solid #333;background:#1c1c1c;color:#fff;
  border-radius:10px;padding:6px 10px;cursor:pointer;
}
.debugbox textarea{
  width:100%; height:110px; margin-top:6px;
  background:#0f0f0f; color:#fff; border:1px solid #333;
  border-radius:10px; padding:8px; box-sizing:border-box;
  font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
</style>
</head>

<body>
<div id="map"></div>
<div class="debugbox" id="dbg"><b>Debug</b><div>Start‚Ä¶</div></div>

<!-- Suche + L√§nder + Unit -->
<div class="box search">
  <div>üîç <input id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶"></div>

  <b style="display:block;margin-top:8px">Land / L√§nder filtern</b>
  <div class="dd" id="countryDropdown">
    <div class="ddbtn" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="ddm" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="dk"> D√§nemark</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="ee"> Estland</label>
      <label><input type="checkbox" class="countryChk" value="fi"> Finnland</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="it"> Italien</label>
      <label><input type="checkbox" class="countryChk" value="lv"> Lettland</label>
      <label><input type="checkbox" class="countryChk" value="lt"> Litauen</label>
      <label><input type="checkbox" class="countryChk" value="nl"> Niederlande</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="se"> Schweden</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="gb"> United Kingdom</label>
    </div>
  </div>

  <div class="row">
    <b style="display:block;margin-bottom:6px">Unit</b>
    <select id="unitSelect">
      <option value="pellets" selected>Pellets</option>
      <option value="streusalz">Streusalz</option>
    </select>
  </div>
</div>

<!-- Zertifikate -->
<div class="box cert" id="certBox">
  <b id="certTitle">Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>

  <div id="sackSection">
    <hr>
    <b>Sackware</b><br>
    <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
    <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
  </div>
</div>

<!-- Farben + Kunden -->
<div class="box legend" id="legendBox">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>

  <div id="kundenFilterPellets">
    <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelleth√§ndler</label><br>
    <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren H√§ndler</label><br>
    <label><input type="checkbox" id="chkSonstigeKunden" checked> üî∂ Sonstige Kunden</label>
  </div>

  <div id="kundenFilterStreusalz" class="hidden">
    <label><input type="checkbox" id="chkKundenStreusalz" checked> üë§ Kunden</label>
  </div>
</div>

<script>
/*** =========================
 *  GEOCACHE.JSON MODE
 *  ========================= */
const GEOCACHE_URL = "./geocache.json";      // Datei neben HTML
const LOCAL_CACHE_KEY = "geoCachePellets_EU_JSON_v1";
const ENABLE_FALLBACK_GEOCODE = false;       // absichtlich AUS

/*** SHEETS ***/
const sheetIdFirmen = "1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk";
const sheetIdKunden = "1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I";
const STREUSALZ_SHEET_NAME = "streusalz";

const sheetUrlFirmenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&gid=0`;
const sheetUrlKundenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&gid=0`;
const sheetUrlFirmenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;
const sheetUrlKundenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;

/*** DEBUG ***/
const dbg = (msg, ok=true) => {
  const el = document.getElementById("dbg");
  if(!el) return;
  const line = document.createElement("div");
  line.className = ok ? "ok" : "bad";
  line.textContent = msg;
  el.appendChild(line);
};
window.addEventListener("error", (e)=>dbg("JS ERROR: "+(e.message||"unknown"), false));
window.addEventListener("unhandledrejection", (e)=>dbg("PROMISE ERROR: "+(e.reason?.message||e.reason||"unknown"), false));

/*** MAP ***/
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:4,maxZoom:18,attribution:"&copy; OpenStreetMap"}).addTo(map);

/*** DOM ***/
const unitSelect = document.getElementById("unitSelect");
const searchInput = document.getElementById("searchInput");
const countryDropdown = document.getElementById("countryDropdown");
const countryDropdownBtn = document.getElementById("countryDropdownBtn");
const countryDropdownMenu = document.getElementById("countryDropdownMenu");
const certTitle = document.getElementById("certTitle");
const sackSection = document.getElementById("sackSection");
const kundenFilterPellets = document.getElementById("kundenFilterPellets");
const kundenFilterStreusalz = document.getElementById("kundenFilterStreusalz");

const chkEnPlus = document.getElementById("chkEnPlus");
const chkDINplus = document.getElementById("chkDINplus");
const chkSURE = document.getElementById("chkSURE");
const chkCPP = document.getElementById("chkCPP");
const chkOhneZert = document.getElementById("chkOhneZert");
const chkSackFireflies = document.getElementById("chkSackFireflies");
const chkSack15kg = document.getElementById("chkSack15kg");

const chkGruen = document.getElementById("chkGruen");
const chkOrange = document.getElementById("chkOrange");
const chkRot = document.getElementById("chkRot");
const chkGrau = document.getElementById("chkGrau");

const chkKunden = document.getElementById("chkKunden");
const chkSackKunden = document.getElementById("chkSackKunden");
const chkSonstigeKunden = document.getElementById("chkSonstigeKunden");
const chkKundenStreusalz = document.getElementById("chkKundenStreusalz");

/*** HELPERS ***/
let currentUnit = unitSelect.value;
const num=v=>{v=String(v??"").trim().replace(",",".");v=v.replace(/‚Ç¨/g,"").trim();const n=+v;return isFinite(n)?n:NaN};
const lc=s=>String(s??"").toLowerCase().trim();
const str=v=>String(v??"").trim();
function isPellets(){ return currentUnit==="pellets"; }
function sackAktiv(){ return isPellets() && (chkSackFireflies.checked || chkSack15kg.checked); }
function colorForPrice(p,kein){
  if(kein||!isFinite(p)||p<=0) return "#9e9e9e";
  if(p<=260) return "green";
  if(p<285) return "orange";
  return "red";
}

const tri=(fill)=>L.divIcon({
  className:"t",
  html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="${fill}" stroke="black" stroke-width="1"/></svg>`,
  iconAnchor:[12,22],popupAnchor:[0,-20]
});
const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

/*** GEO CACHE ***/
let geoCache = {};
try{ geoCache = JSON.parse(localStorage.getItem(LOCAL_CACHE_KEY) || "{}"); }catch(e){ geoCache={}; }
let geoJson = {};
let geoJsonLoaded = false;

function saveLocalGeoCache(){
  try{ localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(geoCache)); }catch(e){}
}
function normKey(s){
  return lc(s)
    .replace(/[‚Äû‚Äú‚Äù"]/g,"")
    .replace(/\s+/g," ")
    .replace(/√ü/g,"ss")
    .replace(/[‚Äô'`]/g,"")
    .replace(/[.,]/g,"")
    .trim();
}
async function getCoordForAddress(address){
  const raw = str(address);
  if(!raw) return null;
  const key = normKey(raw);

  if(geoCache[key]?.lat && geoCache[key]?.lon) return geoCache[key];
  if(geoJsonLoaded && geoJson[key]?.lat && geoJson[key]?.lon){
    geoCache[key] = geoJson[key];
    saveLocalGeoCache();
    return geoJson[key];
  }
  if(!ENABLE_FALLBACK_GEOCODE) return null;
  return null;
}
async function loadGeoJson(){
  dbg("Lade geocache.json ‚Ä¶");
  try{
    const res = await fetch(GEOCACHE_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    geoJson = j && typeof j === "object" ? j : {};
    geoJsonLoaded = true;
    dbg(`geocache.json OK: ${Object.keys(geoJson).length} Orte`, true);
  }catch(e){
    geoJsonLoaded = false;
    geoJson = {};
    dbg(`geocache.json FEHLT/ERROR (${e.message})`, false);
    dbg(`Lege "geocache.json" neben die HTML (gleicher Ordner).`, false);
  }
}

/*** DATA ***/
let werkePellets=null, werkeStreusalz=null, werke=[];
let kundenPellets=null, kundenStreusalz=null, kunden=[];
let alleMarker=[], selectedPoints=[], routeLine=null, searchMarker=null;
let buildToken=0;
let missingAddresses = new Set();

/*** PARSER ***/
function findIndex(headers, cands){
  const hs=headers.map(h=>lc(h));
  const cs=cands.map(c=>lc(c));
  return hs.findIndex(h=>cs.includes(h));
}
function parseFirmenArray(table){
  if(!table || table.length<2) return [];
  const headers=(table[0]||[]).map(x=>str(x));
  const rows=table.slice(1);

  let nameIdx = findIndex(headers, ["firma","name","werk"]); if(nameIdx<0) nameIdx = 0;
  let ortIdx  = findIndex(headers, ["ort","stadt","standort","adresse","location"]); if(ortIdx<0) ortIdx = 1;

  const preisIdx = 2;
  let sackIdx = findIndex(headers, ["sackwarenpreis","sackwarepreis","preis_sack","sackpreis","preis sack"]);
  if(sackIdx<0) sackIdx = 3;

  let zertIdx = findIndex(headers, ["zertifikat","zertifikate","zert","cert"]); if(zertIdx<0) zertIdx = -1;
  let sackTxtIdx = findIndex(headers, ["sackware","sack","bag","bagged"]); if(sackTxtIdx<0) sackTxtIdx = -1;

  return rows
    .filter(r=>str(r[nameIdx]) && str(r[ortIdx]))
    .map(r=>{
      const p = num(r[preisIdx]);
      const ps = num(r[sackIdx]);
      return {
        firma: str(r[nameIdx]),
        ort: str(r[ortIdx]),
        preis: p,
        preisSack: ps,
        zert: zertIdx>=0 ? str(r[zertIdx]) : "",
        sack: sackTxtIdx>=0 ? str(r[sackTxtIdx]) : "",
        _preisOrig: p,
        _preisSackOrig: ps
      };
    });
}
function parseKunden(rows){
  const keys=Object.keys(rows[0]||{});
  const nameKey=(keys.find(k=>["name","kunde","kundenname"].includes(lc(k)))||keys[0]);
  const ortKey=(keys.find(k=>["ort","adresse","standort","anschrift","stadt","location"].includes(lc(k)))||keys[1]);
  const loseKey=(keys.find(k=>lc(k)==="lose")||"lose");
  const sackKey=(keys.find(k=>lc(k)==="sackware")||"sackware");
  const sonstKey=(keys.find(k=>lc(k)==="sonstige")||"sonstige");

  return rows.map(x=>({
    name:str(x[nameKey]),
    ort:str(x[ortKey]),
    lose:lc(x[loseKey]),
    sackware:lc(x[sackKey]),
    sonstige:lc(x[sonstKey])
  })).filter(x=>x.name&&x.ort);
}
function normalizePreise(d){
  const w=d.filter(x=>isFinite(x.preis)&&x.preis>0);
  const s=d.filter(x=>isFinite(x.preisSack)&&x.preisSack>0);
  const avgW=w.length?w.reduce((a,b)=>a+b.preis,0)/w.length:0;
  const avgS=s.length?s.reduce((a,b)=>a+b.preisSack,0)/s.length:0;

  return d.map(x=>{
    x.keinPreisWerk = !(isFinite(x._preisOrig) && x._preisOrig>0);
    x.keinPreisSack = !(isFinite(x._preisSackOrig) && x._preisSackOrig>0);
    if(x.keinPreisWerk) x.preis = avgW;
    if(x.keinPreisSack) x.preisSack = avgS;
    x.farbeWerk = colorForPrice(x._preisOrig, x.keinPreisWerk);
    x.farbeSack = colorForPrice(x._preisSackOrig, x.keinPreisSack);
    return x;
  });
}

/*** LOADERS ***/
async function loadWerkeForUnit(unit){
  if(unit==="pellets" && werkePellets) return werkePellets;
  if(unit==="streusalz" && werkeStreusalz) return werkeStreusalz;

  const url = (unit==="pellets") ? sheetUrlFirmenPellets : sheetUrlFirmenStreusalz;
  dbg("Lade FIRMEN: " + unit + " ‚Ä¶");

  const data = await new Promise(res=>{
    Papa.parse(url,{
      download:true, header:false, skipEmptyLines:true,
      complete:r=>{
        dbg(`FIRMEN OK (${unit}): rows=${(r.data||[]).length} errors=${(r.errors||[]).length}`, true);
        try{ res(normalizePreise(parseFirmenArray(r.data||[]))) }
        catch(e){ dbg("FIRMEN PARSE CRASH: "+e.message, false); res([]); }
      },
      error: err=>{ dbg("FIRMEN FAIL: "+(err?.message||"unknown"), false); res([]); }
    });
  });

  if(unit==="pellets") werkePellets=data; else werkeStreusalz=data;
  return data;
}

async function loadKundenForUnit(unit){
  if(unit==="pellets" && kundenPellets) return kundenPellets;
  if(unit==="streusalz" && kundenStreusalz) return kundenStreusalz;

  const url = (unit==="pellets") ? sheetUrlKundenPellets : sheetUrlKundenStreusalz;
  dbg("Lade KUNDEN: " + unit + " ‚Ä¶");

  const data = await new Promise(res=>{
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true,
      complete:r=>{
        dbg(`KUNDEN OK (${unit}): rows=${(r.data||[]).length} errors=${(r.errors||[]).length}`, true);
        try{ res(parseKunden(r.data||[])) }
        catch(e){ dbg("KUNDEN PARSE CRASH: "+e.message, false); res([]); }
      },
      error: err=>{ dbg("KUNDEN FAIL: "+(err?.message||"unknown"), false); res([]); }
    });
  });

  if(unit==="pellets") kundenPellets=data; else kundenStreusalz=data;
  return data;
}

/*** COUNTRY UI ***/
function getSelectedCountries(){
  const s=[...document.querySelectorAll(".countryChk")].filter(c=>c.checked).map(c=>c.value);
  return (!s.length||s.includes("all"))?["all"]:s;
}
function updateCountryButtonLabel(){
  const s=getSelectedCountries();
  if(s.length===1&&s[0]==="all") return countryDropdownBtn.textContent="Alle L√§nder";
  const names={be:"BE",dk:"DK",de:"DE",ee:"EE",fi:"FI",fr:"FR",it:"IT",lv:"LV",lt:"LT",nl:"NL",at:"AT",pl:"PL",se:"SE",ch:"CH",sk:"SK",cz:"CZ",gb:"UK"};
  countryDropdownBtn.textContent=s.map(c=>names[c]||c.toUpperCase()).join(", ");
}

/*** Missing Box ***/
function renderMissingBox(){
  const dbgEl = document.getElementById("dbg");
  if(!dbgEl) return;

  const old = dbgEl.querySelector(".missingWrap");
  if(old) old.remove();
  if(missingAddresses.size === 0) return;

  const wrap = document.createElement("div");
  wrap.className = "missingWrap";
  const list = [...missingAddresses].slice(0, 300).join("\n");

  wrap.innerHTML = `
    <div style="margin-top:8px;font-weight:700">Fehlende Orte (${missingAddresses.size})</div>
    <button class="btn" id="copyMissing">üìã Kopieren</button>
    <textarea readonly id="missingText"></textarea>
  `;
  dbgEl.appendChild(wrap);

  const ta = wrap.querySelector("#missingText");
  ta.value = list;

  wrap.querySelector("#copyMissing").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(ta.value);
      dbg("Fehlende Orte kopiert ‚úÖ", true);
    }catch(e){
      ta.select(); document.execCommand("copy");
      dbg("Kopieren (fallback) ‚úÖ", true);
    }
  });
}

/*** BUILD MAP ***/
async function buildMap(){
  const myToken=++buildToken;

  for(const m of alleMarker){ try{ map.removeLayer(m.marker);}catch(e){} }
  alleMarker=[];
  missingAddresses = new Set();

  const bounds=L.latLngBounds();

  // Firmen
  for(const w of werke){
    if(myToken!==buildToken) return;
    const c = await getCoordForAddress(w.ort);
    if(!c){ missingAddresses.add(str(w.ort)); continue; }

    const farbe = (isPellets() && sackAktiv()) ? w.farbeSack : w.farbeWerk;
    const cm=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
      .bindTooltip(`<b>${w.firma}</b><br>${w.ort}`,{sticky:true})
      .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}));

    alleMarker.push({type:"firma",marker:cm,...w,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    if(myToken!==buildToken) return;
    const c = await getCoordForAddress(k.ort);
    if(!c){ missingAddresses.add(str(k.ort)); continue; }

    let type="kunde", icon=iconBlue;
    if(isPellets()){
      const isSackOnly=(k.sackware==="ja")&&(k.lose!=="ja");
      const isSonstige=(k.sonstige==="ja");
      type=isSonstige?"sonstige":isSackOnly?"sackkunde":"kunde";
      icon=isSonstige?iconOrange:isSackOnly?iconPurple:iconBlue;
    }else{
      type="streukunde";
      icon=iconBlue;
    }

    const mk=L.marker([c.lat,c.lon],{icon})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`,{sticky:true})
      .on("click",()=>pickPoint(k.name,{lat:c.lat,lon:c.lon}));

    alleMarker.push({type,marker:mk,...k,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}});
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.15));
  updateLayers();

  if(missingAddresses.size){
    dbg(`Fehlende Koordinaten: ${missingAddresses.size}`, false);
    renderMissingBox();
  }else{
    dbg("Alle Orte gefunden ‚úÖ", true);
    renderMissingBox();
  }
}

/*** ROUTE ***/
function pickPoint(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints; selectedPoints=[];
    showRouteByCoords(a.label,a.coord,b.label,b.coord);
  }
}
function clearRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
  map.closePopup();
  selectedPoints = [];
}
function luftlinieKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon), la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2+Math.cos(la1)*la2 && 0 || (Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2);
  // fix: do it correctly:
}
function haversineKm(a,b){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}
async function showRouteByCoords(aLabel,aCoord,bLabel,bCoord){
  const osrm=`https://router.project-osrm.org/route/v1/driving/${aCoord.lon},${aCoord.lat};${bCoord.lon},${bCoord.lat}?overview=full&geometries=geojson`;
  let distKm=null, coords=null, dashed=false;
  try{
    const res=await fetch(osrm);
    const data=res.ok?await res.json():null;
    if(data?.routes?.length){
      const r=data.routes[0];
      distKm=r.distance/1000;
      coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
    }
  }catch(e){}
  if(!distKm){
    distKm=haversineKm(aCoord,bCoord);
    coords=[[aCoord.lat,aCoord.lon],[bCoord.lat,bCoord.lon]];
    dashed=true;
  }

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:"blue",weight:5,opacity:.85,dashArray:dashed?"8 8":null}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

/*** LAYERS ***/
function updateLayers(){
  const selected=getSelectedCountries(), noCountry=(selected.length===1&&selected[0]==="all");
  const gr=chkGruen.checked, or=chkOrange.checked, ro=chkRot.checked, ga=chkGrau.checked;

  const showPelletK = isPellets() ? chkKunden.checked : false;
  const showPelletSK = isPellets() ? chkSackKunden.checked : false;
  const showPelletS = isPellets() ? chkSonstigeKunden.checked : false;
  const showStreuK = !isPellets() ? chkKundenStreusalz.checked : false;

  for(const m of alleMarker){
    if(map.hasLayer(m.marker)) map.removeLayer(m.marker);

    if(!noCountry && m.country_code && !selected.includes(m.country_code)) continue;

    if(m.type==="kunde"){ if(showPelletK) map.addLayer(m.marker); continue; }
    if(m.type==="sackkunde"){ if(showPelletSK) map.addLayer(m.marker); continue; }
    if(m.type==="sonstige"){ if(showPelletS) map.addLayer(m.marker); continue; }
    if(m.type==="streukunde"){ if(showStreuK) map.addLayer(m.marker); continue; }

    const farbe = (isPellets() && sackAktiv()) ? m.farbeSack : m.farbeWerk;
    const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
    if(!ok) continue;

    m.marker.setStyle?.({color:farbe,fillColor:farbe});
    map.addLayer(m.marker);
  }
}

/*** UNIT UI ***/
function applyUnitUIOnly(){
  if(isPellets()){
    certTitle.textContent = "Zertifikate & Sackware";
    sackSection.classList.remove("hidden");
    kundenFilterPellets.classList.remove("hidden");
    kundenFilterStreusalz.classList.add("hidden");
  }else{
    certTitle.textContent = "Zertifikate";
    sackSection.classList.add("hidden");
    kundenFilterPellets.classList.add("hidden");
    kundenFilterStreusalz.classList.remove("hidden");
    chkSackFireflies.checked = false;
    chkSack15kg.checked = false;
  }
}

/*** SWITCH UNIT ***/
async function switchUnit(newUnit){
  currentUnit = newUnit;
  applyUnitUIOnly();

  werke = await loadWerkeForUnit(currentUnit);
  kunden = await loadKundenForUnit(currentUnit);

  dbg(`Nach Load: werke=${werke.length} kunden=${kunden.length}`, true);
  await buildMap();
}
unitSelect.addEventListener("change", async ()=>{ await switchUnit(unitSelect.value); });

/*** EVENTS ***/
document.addEventListener("change",e=>{
  if(e.target?.matches('input[type="checkbox"]')){
    if(e.target.classList.contains("countryChk")){
      if(e.target.value==="all"&&e.target.checked) [...document.querySelectorAll(".countryChk")].forEach(x=>x.value!=="all"&&(x.checked=false));
      if(e.target.value!=="all"&&e.target.checked) document.querySelector('.countryChk[value="all"]').checked=false;
      updateCountryButtonLabel();
    }
    updateLayers();
  }
});
countryDropdownBtn.addEventListener("click",()=>countryDropdownMenu.style.display=(countryDropdownMenu.style.display==="block"?"none":"block"));
document.addEventListener("click",e=>{if(!countryDropdown.contains(e.target)) countryDropdownMenu.style.display="none"});

map.on("click", ()=>clearRoute());
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") clearRoute(); });

/*** SEARCH ***/
searchInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const raw=e.target.value.trim(); if(!raw) return;

  if(searchMarker){ try{ map.removeLayer(searchMarker); }catch(err){} searchMarker=null; }

  const q=lc(raw);
  const matches=alleMarker.filter(m=>{
    const name=lc(m.firma||m.name), ort=lc(m.ort);
    return name.includes(q)||ort.includes(q);
  });

  const bounds=L.latLngBounds();
  matches.forEach((m,i)=>{
    if(!map.hasLayer(m.marker)) map.addLayer(m.marker);
    bounds.extend(m.marker.getLatLng());
    if(i===0) m.marker.openTooltip?.();
  });

  const c = await getCoordForAddress(raw);
  if(c){
    const ll=[c.lat,c.lon];
    searchMarker=L.circleMarker(ll,{radius:8,color:"blue",fillColor:"blue",fillOpacity:.5}).addTo(map);
    bounds.extend(ll);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.2));
  else alert("Kein Treffer gefunden.");
});

/*** INIT ***/
(async()=>{
  dbg("Init‚Ä¶", true);
  updateCountryButtonLabel();
  applyUnitUIOnly();
  await loadGeoJson();
  await switchUnit(unitSelect.value);
})();
</script>
</body>
</html>
