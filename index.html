<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Europa Preiskarte ‚Äì Pellets / Streusalz</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html,body{height:100%;margin:0}#map{height:100%;width:100%}
.box{position:absolute;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);font:14px/1.3 system-ui,Arial;z-index:2000}
.search{top:12px;right:12px;width:260px}
.legend{bottom:12px;right:12px;min-width:180px;z-index:3000}
.cert{bottom:12px;left:12px;z-index:2500}
.box input[type="checkbox"]{width:14px;height:14px;margin-right:5px;vertical-align:middle}
.search input,.search select{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;box-sizing:border-box}
.search .row{margin-top:8px}
.cert hr{border:none;height:1px;background:#eee;margin:6px 0}

.dd{position:relative;display:block;width:100%;margin-top:8px}
.ddbtn{width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;padding:4px 6px;text-align:left;cursor:pointer;box-sizing:border-box}
.ddbtn:after{content:"‚ñæ";float:right;opacity:.6}
.ddm{position:absolute;top:110%;left:0;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:4000;display:none;min-width:160px;max-height:260px;overflow:auto;padding:6px 8px;box-sizing:border-box}
.ddm label{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;margin:0;white-space:nowrap}

/* ===== Rechtsklick-Box (Kundenmen√º) ===== */
.ctxbox{
  position:absolute; z-index:6000;
  background:#fff; border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  padding:10px; width:280px;
  font:14px/1.25 system-ui, Arial;
  border:1px solid rgba(0,0,0,.10);
}
.ctxbox b{display:block;margin-bottom:6px}
.ctxbox .row{display:flex; gap:8px; margin:8px 0}
.ctxbox select,.ctxbox input{width:100%; padding:7px 8px; border:1px solid #ccc; border-radius:6px; outline:none; box-sizing:border-box;}
.ctxbox .results{margin-top:8px; max-height:240px; overflow:auto; border-top:1px solid #eee; padding-top:8px;}
.ctxbox .item{padding:8px; border:1px solid #eee; border-radius:8px; cursor:pointer; margin:6px 0;}
.ctxbox .item:hover{background:#fafafa}
.ctxbox .small{font-size:12px;opacity:.75}
.ctxbox .pill{display:inline-block; padding:2px 6px; border-radius:999px; background:#f2f2f2; font-size:12px; margin-left:6px;}
.ctxbox .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
.ctxbox .xbtn{border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;padding:2px 8px; line-height:1.6;}
.hidden{display:none!important}

/* Buttons im Firmen-Popup */
.btnRow{display:flex;gap:8px;margin-top:8px}
.btn{border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;padding:6px 10px}
.btn:hover{background:#fafafa}
.small{font-size:12px;opacity:.75}

/* ===== Modal: Firma hinzuf√ºgen (Taste F) ===== */
.modalOverlay{ position:absolute; inset:0; background:transparent; z-index:8000; }
.modal{
  position:absolute; z-index:9000; width:320px; background:#fff;
  border:1px solid rgba(0,0,0,.10); border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.22);
  font:14px/1.25 system-ui,Arial;
}
.modalHead{
  padding:10px 12px; display:flex; align-items:center; justify-content:space-between;
  cursor:move; border-bottom:1px solid #eee;
}
.modalTitle{font-weight:700}
.modalX{ border:1px solid #ddd;background:#fff;border-radius:10px; cursor:pointer; padding:2px 10px; line-height:1.6; }
.modalBody{padding:12px}
.modalBody .row{margin:10px 0}
.modalBody input{
  width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; outline:none; box-sizing:border-box;
}

/* ===== Inputs f√ºr Farb-Grenzen in der Legende ===== */
.thInp{
  width:70px;
  padding:2px 6px;
  border:1px solid #ccc;
  border-radius:6px;
  outline:none;
  box-sizing:border-box;
  font:12px/1.2 system-ui, Arial;
  margin:0 4px;
}

/* ===== Preisindex Panel (Slide-out) ===== */
.indexDock{
  position:absolute;
  left:12px;
  bottom:300px;
  z-index:2600;
  display:flex;
  align-items:flex-start;
  gap:8px;
}
.indexToggle{
  width:28px;
  height:44px;
  border:1px solid #ddd;
  background:#fff;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.indexToggle:hover{background:#fafafa}
.indexToggle span{
  display:block;
  font-size:18px;
  line-height:1;
  opacity:.8;
  transform:translateX(1px);
}

.indexPanel{
  width:560px;
  max-width:calc(100vw - 70px);
  background:#fff;
  border:1px solid rgba(0,0,0,.10);
  border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  overflow:hidden;
  transform:translateX(-120%);
  transition:transform .22s ease;
}
.indexPanel.open{ transform:translateX(0); }

.indexHead{
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid #eee;
  font:14px/1.25 system-ui,Arial;
}
.indexTitleWrap{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
.indexTitle{
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.indexLockBtn{
  border:1px solid #ddd;
  background:#fff;
  border-radius:10px;
  cursor:pointer;
  padding:2px 8px;
  line-height:1.6;
  user-select:none;
}
.indexLockBtn:hover{background:#fafafa}

.indexControls{
  display:flex;
  gap:8px;
  align-items:center;
}

.indexControls input{
  width:180px;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:8px;
  outline:none;
}
.indexControls button{
  padding:6px 10px;
  border:1px solid #ddd;
  background:#fff;
  border-radius:8px;
  cursor:pointer;
}
.indexControls button:hover{background:#fafafa}

.indexControls select{
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:8px;
  outline:none;
}
.indexBody{
  padding:10px 12px 12px;
  height:260px;
  box-sizing:border-box;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- Suche + L√§nder + Unit -->
<div class="box search">
  <div>üîç <input id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶"></div>

  <b style="display:block;margin-top:8px">Land / L√§nder filtern</b>
  <div class="dd" id="countryDropdown">
    <div class="ddbtn" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="ddm" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="dk"> D√§nemark</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="ee"> Estland</label>
      <label><input type="checkbox" class="countryChk" value="fi"> Finnland</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="it"> Italien</label>
      <label><input type="checkbox" class="countryChk" value="lv"> Lettland</label>
      <label><input type="checkbox" class="countryChk" value="lt"> Litauen</label>
      <label><input type="checkbox" class="countryChk" value="nl"> Niederlande</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="se"> Schweden</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="gb"> United Kingdom</label>
    </div>
  </div>

  <div class="row">
    <b style="display:block;margin-bottom:6px">Unit</b>
    <select id="unitSelect">
      <option value="pellets" selected>Pellets</option>
      <option value="streusalz">Streusalz</option>
    </select>
  </div>
</div>

<!-- Zertifikate -->
<div class="box cert" id="certBox">
  <b id="certTitle">Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>

  <div id="sackSection">
    <hr>
    <b>Sackware</b><br>
    <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
    <label><input type="checkbox" id="chkSack15kg"> 15 kg</label><br>
    <label><input type="checkbox" id="chkBigBag"> Big Bag</label>
  </div>
</div>

<!-- Preisindex (ausklappbar) -->
<div class="indexDock" id="indexDock">
  <button class="indexToggle" id="indexToggle" type="button" title="Preisindex √∂ffnen/schlie√üen">
    <span id="indexArrow">‚Ä∫</span>
  </button>

  <div class="indexPanel" id="indexPanel">
    <div class="indexHead">
      <div class="indexTitleWrap">
        <div class="indexTitle" id="indexFirmTitle">Preisindex</div>
        <button class="indexLockBtn" id="indexLockBtn" type="button" title="Index entsperren">üîì</button>
      </div>
      <div class="indexControls">
        <input id="indexFirmSearch" placeholder="Firma suchen‚Ä¶" autocomplete="off">
        <button id="indexFirmSearchBtn" type="button">Suchen</button>

        <select id="indexRange">
          <option value="3">3 Monate</option>
          <option value="6">6 Monate</option>
          <option value="12">12 Monate</option>
          <option value="24">24 Monate</option>
        </select>
      </div>
    </div>
    <div class="indexBody">
      <canvas id="indexChart"></canvas>
    </div>
  </div>
</div>

<!-- Farben + Kunden -->
<div class="box legend" id="legendBox">
  <b>Filter Farben</b><br>

  <label>
    <input type="checkbox" id="chkGruen" checked>
    üü¢ ‚â§ <input class="thInp" id="thGreen" type="number" step="0.01"> ‚Ç¨
  </label><br>

  <label>
    <input type="checkbox" id="chkOrange" checked>
    üü† <span id="thOrangeFromTxt">‚Ä¶</span>‚Äì<input class="thInp" id="thOrange" type="number" step="0.01"> ‚Ç¨
  </label><br>

  <label>
    <input type="checkbox" id="chkRot" checked>
    üî¥ ‚â• <span id="thRedFromTxt">‚Ä¶</span> ‚Ç¨
  </label><br>

  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>

  <div id="kundenFilterPellets">
    <label><input type="checkbox" id="chkKunden" checked> üî∑ Pelleth√§ndler</label><br>
    <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren H√§ndler</label><br>
    <label><input type="checkbox" id="chkSonstigeKunden" checked> üî∂ Sonstige Kunden</label>
  </div>

  <div id="kundenFilterStreusalz" class="hidden">
    <label><input type="checkbox" id="chkKundenStreusalz" checked> üë§ Kunden</label>
  </div>
</div>

<script>
/*** ====== SHEETS (DEINE IDS) ====== ***/
const sheetIdFirmen = "1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk";
const sheetIdKunden = "1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I";
const STREUSALZ_SHEET_NAME = "streusalz";
const INDEX_SHEET_NAME = "index";

const sheetUrlFirmenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/export?format=csv&gid=0`;
const sheetUrlKundenPellets   = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/export?format=csv&gid=0`;

const sheetUrlFirmenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;
const sheetUrlKundenStreusalz = `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(STREUSALZ_SHEET_NAME)}`;

const sheetUrlIndexHistory = `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(INDEX_SHEET_NAME)}`;

/*** ====== MAP ====== ***/
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:4,maxZoom:18,attribution:"&copy; OpenStreetMap"}).addTo(map);

/*** ====== DOM ====== ***/
const unitSelect = document.getElementById("unitSelect");
const searchInput = document.getElementById("searchInput");

const countryDropdown = document.getElementById("countryDropdown");
const countryDropdownBtn = document.getElementById("countryDropdownBtn");
const countryDropdownMenu = document.getElementById("countryDropdownMenu");

const certTitle = document.getElementById("certTitle");
const sackSection = document.getElementById("sackSection");

const kundenFilterPellets = document.getElementById("kundenFilterPellets");
const kundenFilterStreusalz = document.getElementById("kundenFilterStreusalz");

const chkEnPlus = document.getElementById("chkEnPlus");
const chkDINplus = document.getElementById("chkDINplus");
const chkSURE = document.getElementById("chkSURE");
const chkCPP = document.getElementById("chkCPP");
const chkOhneZert = document.getElementById("chkOhneZert");

const chkSackFireflies = document.getElementById("chkSackFireflies");
const chkSack15kg = document.getElementById("chkSack15kg");
const chkBigBag = document.getElementById("chkBigBag");

const chkGruen = document.getElementById("chkGruen");
const chkOrange = document.getElementById("chkOrange");
const chkRot = document.getElementById("chkRot");
const chkGrau = document.getElementById("chkGrau");

const chkKunden = document.getElementById("chkKunden");
const chkSackKunden = document.getElementById("chkSackKunden");
const chkSonstigeKunden = document.getElementById("chkSonstigeKunden");
const chkKundenStreusalz = document.getElementById("chkKundenStreusalz");

const thGreen = document.getElementById("thGreen");
const thOrange = document.getElementById("thOrange");
const thOrangeFromTxt = document.getElementById("thOrangeFromTxt");
const thRedFromTxt = document.getElementById("thRedFromTxt");

// Preisindex Panel DOM
const indexToggle = document.getElementById("indexToggle");
const indexPanel  = document.getElementById("indexPanel");
const indexArrow  = document.getElementById("indexArrow");
const indexRange  = document.getElementById("indexRange");
const indexFirmTitle = document.getElementById("indexFirmTitle");
const indexFirmSearch = document.getElementById("indexFirmSearch");
const indexFirmSearchBtn = document.getElementById("indexFirmSearchBtn");
const indexLockBtn = document.getElementById("indexLockBtn");

/*** ====== STATE / HELPERS ====== ***/
let currentUnit = unitSelect.value;
let buildToken = 0;

const num=v=>{
  v=String(v??"").trim().replace(",",".");
  v=v.replace(/[^0-9.\-]/g,"");
  const n=+v;
  return isFinite(n)?n:NaN;
};
const lc=s=>String(s??"").toLowerCase().trim();
const str=v=>String(v??"").trim();
const uid=()=>Math.random().toString(36).slice(2) + Date.now().toString(36);

// normalisiert Firmennamen robust (whitespace etc.)
const normName = (s)=>{
  s = str(s);
  return lc(s).replace(/\s+/g," ").trim();
};

function isPellets(){ return currentUnit==="pellets"; }
function sackAktiv(){
  return isPellets() && (chkSackFireflies.checked || chkSack15kg.checked || chkBigBag.checked);
}

/*** ====== FARBSCHWELLEN (editierbar + gespeichert) ====== ***/
const THRESH_KEY = "colorThresholds_EU_v1";
let thresholds = JSON.parse(localStorage.getItem(THRESH_KEY) || "{}");
const saveThresholds = ()=>localStorage.setItem(THRESH_KEY, JSON.stringify(thresholds));

function priceTypeKey(){
  if(!isPellets()) return "lose";
  return sackAktiv() ? "sack" : "lose";
}
function ensureThresholdObj(){
  if(!thresholds || typeof thresholds!=="object") thresholds = {};
  if(!thresholds[currentUnit]) thresholds[currentUnit] = {};
  const pt = priceTypeKey();
  if(!thresholds[currentUnit][pt]) thresholds[currentUnit][pt] = { greenMax: 260, orangeMax: 285 };
  const t = thresholds[currentUnit][pt];
  if(!isFinite(+t.greenMax) || +t.greenMax<=0) t.greenMax = 260;
  if(!isFinite(+t.orangeMax) || +t.orangeMax<=0) t.orangeMax = 285;
  if(+t.orangeMax <= +t.greenMax) t.orangeMax = +t.greenMax + 1;
  return t;
}
function getThresholds(){ return ensureThresholdObj(); }
function setThresholds(greenMax, orangeMax){
  const pt = priceTypeKey();
  ensureThresholdObj();
  thresholds[currentUnit][pt].greenMax = greenMax;
  thresholds[currentUnit][pt].orangeMax = orangeMax;
  saveThresholds();
}
function refreshLegendThresholdUI(){
  const t = getThresholds();
  thGreen.value = (+t.greenMax).toFixed(2);
  thOrange.value = (+t.orangeMax).toFixed(2);
  thOrangeFromTxt.textContent = (+t.greenMax).toFixed(2);
  thRedFromTxt.textContent = (+t.orangeMax).toFixed(2);
}
function colorForPrice(p,kein){
  const t = getThresholds();
  const g = +t.greenMax;
  const o = +t.orangeMax;
  if(kein||!isFinite(p)||p<=0) return "#9e9e9e";
  if(p<=g) return "green";
  if(p<o) return "orange";
  return "red";
}

/*** ====== MANUELLE PREISE (pro Firma + Unit + Lose/Sack) ====== ***/
const MANUAL_KEY = "manualPrices_EU_v1";
let manualPrices = JSON.parse(localStorage.getItem(MANUAL_KEY) || "{}");
const saveManual = ()=>localStorage.setItem(MANUAL_KEY, JSON.stringify(manualPrices));

function manualKeyForFirm(firma){
  return `${currentUnit}|${priceTypeKey()}|${str(firma)}`;
}
function getManualPriceForFirm(firma){
  const k = manualKeyForFirm(firma);
  const v = manualPrices[k];
  return (isFinite(+v) && +v>0) ? +v : null;
}
function setManualPriceForFirm(firma, value){
  const k = manualKeyForFirm(firma);
  if(!isFinite(value) || value<=0){
    delete manualPrices[k];
  }else{
    manualPrices[k] = value;
  }
  saveManual();
}

/* Effektiver Preis + effektive Farbe (manuell hat Vorrang) */
function getEffectiveFirmPrice(m){
  const manual = getManualPriceForFirm(m.firma);
  if(manual) return { price: manual, isManual: true, hasReal: true };

  const isSack = isPellets() && sackAktiv();
  const orig = isSack ? m._preisSackOrig : m._preisOrig;
  const hasReal = isSack ? !m.keinPreisSack : !m.keinPreisWerk;
  return { price: orig, isManual: false, hasReal };
}
function getEffectiveFirmColor(m){
  const { price, hasReal } = getEffectiveFirmPrice(m);
  return colorForPrice(price, !hasReal);
}

/*** ====== PREISINDEX PANEL + CHART ====== ***/
let indexOpen = false;
let indexChart = null;
let historyRows = null;
let historyByFirm = {};
let activeIndexFirm = null;

// ‚úÖ HARD LOCK: wenn true, darf Hover NIEMALS Index √§ndern
let indexLocked = false;
let indexLockedFirm = null;

function setIndexLock(state, firm){
  indexLocked = !!state;
  indexLockedFirm = indexLocked ? (firm ? str(firm) : indexLockedFirm) : null;
  indexLockBtn.textContent = indexLocked ? "üîí" : "üîì";
  indexLockBtn.title = indexLocked ? "Index ist fixiert (klicken zum l√∂sen)" : "Index ist frei (klicken zum fixieren)";
}
indexLockBtn.addEventListener("click", ()=>{
  if(indexLocked){
    setIndexLock(false, null);
    if(activeIndexFirm) renderIndexForFirm(activeIndexFirm, {keepLock:true});
  }else{
    if(activeIndexFirm) setIndexLock(true, activeIndexFirm);
    if(activeIndexFirm) renderIndexForFirm(activeIndexFirm, {keepLock:true});
  }
});

function setIndexOpen(v){
  indexOpen = !!v;
  indexPanel.classList.toggle("open", indexOpen);
  indexArrow.textContent = indexOpen ? "‚Äπ" : "‚Ä∫";
}
indexToggle.addEventListener("click", ()=> setIndexOpen(!indexOpen));

indexRange.addEventListener("change", ()=>{
  const name = indexLocked ? indexLockedFirm : activeIndexFirm;
  if(name) renderIndexForFirm(name, {keepLock:true});
});

function parseDateFlex(s){
  s = str(s);
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const d = new Date(s+"T00:00:00");
    return isNaN(+d) ? null : d;
  }
  const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);
  if(m){
    let y = +m[3];
    if(y < 100) y = 2000 + y;
    const d = new Date(y, (+m[2]-1), +m[1]);
    return isNaN(+d) ? null : d;
  }
  const d = new Date(s);
  return isNaN(+d) ? null : d;
}
function formatLabelDate(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = String(d.getFullYear()).slice(-2);
  return `${dd}.${mm}.${yy}`;
}
function filterByMonths(arr, months){
  if(!arr || !arr.length) return [];
  const m = +months || 3;
  const last = arr[arr.length-1].date;
  const cutoff = new Date(last);
  cutoff.setMonth(cutoff.getMonth() - m);
  return arr.filter(x=>x.date >= cutoff);
}

function getCellCI(row, names){
  const keys = Object.keys(row||{});
  for(const want of names){
    const w = lc(want);
    const hit = keys.find(k=>lc(k)===w);
    if(hit !== undefined) return row[hit];
  }
  return "";
}

async function loadIndexHistoryOnce(){
  if(historyRows) return;

  historyRows = await new Promise(res=>Papa.parse(sheetUrlIndexHistory,{
    download:true, header:true, skipEmptyLines:true,
    complete:r=>{ res(r.data||[]) },
    error:_=>res([])
  }));

  historyByFirm = {};
  for(const row of historyRows){
    const firmRaw = getCellCI(row, ["firma","Firma","name","Name"]);
    const dateRaw = getCellCI(row, ["datum","Datum","date","Date"]);
    const loseRaw = getCellCI(row, ["losePreis","LosePreis","losepreis","Lose","lose"]);
    const sackRaw = getCellCI(row, ["sackPreis","SackPreis","sackpreis","Sack","sack"]);

    const firmKey = normName(firmRaw);
    if(!firmKey) continue;

    const d = parseDateFlex(dateRaw);
    if(!d) continue;

    const o = { date: d, lose: num(loseRaw), sack: num(sackRaw) };
    if(!historyByFirm[firmKey]) historyByFirm[firmKey] = [];
    historyByFirm[firmKey].push(o);
  }

  for(const k of Object.keys(historyByFirm)){
    historyByFirm[k].sort((a,b)=>a.date-b.date);
  }
}

/* ‚úÖ Plugin: Titel unten mittig im Chart */
const bottomTitlePlugin = {
  id: "bottomTitlePlugin",
  afterDraw(chart){
    const text = chart?.options?.bottomTitleText || "";
    if(!text) return;

    const { ctx, chartArea } = chart;
    if(!chartArea) return;

    const x = (chartArea.left + chartArea.right) / 2;
    const y = chartArea.bottom + 45; // unterhalb der Achse

    ctx.save();
    ctx.font = "700 14px system-ui, Arial";
    ctx.fillStyle = "#333";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }
};

function ensureIndexChart(){
  if(indexChart) return indexChart;

  const ctx = document.getElementById("indexChart").getContext("2d");
  indexChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label: "Lose Ware", data: [], tension: 0.25, pointRadius: 0, borderWidth: 3 },
        { label: "Sackware", data: [], tension: 0.25, pointRadius: 0, borderWidth: 3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },

      /* ‚úÖ Platz schaffen f√ºr die √úberschrift unten */
      layout: {
        padding: { bottom: 65 }
      },

      /* ‚úÖ wird in renderIndexForFirm gesetzt */
      bottomTitleText: "",

      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            afterBody: (items)=>{
              const a = items?.[0]?.parsed?.y;
              const b = items?.[1]?.parsed?.y;
              if(isFinite(a) && isFinite(b)){
                const diff = (b - a);
                const sign = diff>=0 ? "+" : "";
                return `Differenz (Sack - Lose): ${sign}${diff.toFixed(2)} ‚Ç¨`;
              }
              return "";
            }
          }
        }
      },
      scales: {
        y: { ticks: { callback: (v)=> `${Math.round(+v)} ‚Ç¨` } }
      }
    },
    plugins: [bottomTitlePlugin]
  });

  return indexChart;
}

async function renderIndexForFirm(firmaName, opts={}){
  await loadIndexHistoryOnce();

  activeIndexFirm = str(firmaName);

  const lockTag = indexLocked = "";
  indexFirmTitle.textContent = "";

  const key = normName(firmaName);
  const rows = historyByFirm[key] || [];

  const chart = ensureIndexChart();

  /* ‚úÖ √úberschrift unten mittig im Chart */
  chart.options.bottomTitleText = firmaName ? `Preisindex ‚Äì ${firmaName}` : "";

  if(!rows.length){
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.update();
    return;
  }

  const months = indexRange.value;
  const use = filterByMonths(rows, months);

  chart.data.labels = use.map(x=>formatLabelDate(x.date));
  chart.data.datasets[0].data = use.map(x=>isFinite(x.lose)?x.lose:null);
  chart.data.datasets[1].data = use.map(x=>isFinite(x.sack)?x.sack:null);
  chart.update();
}

/* ‚úÖ Index-Suche: sucht erst in werke, dann in history keys */
function findBestFirmMatch(query){
  const q = normName(query);
  if(!q) return null;

  // 1) in werke (echte Firmennamen)
  const list = (werke || []).map(w => str(w.firma)).filter(Boolean);

  let exact = list.find(n => normName(n) === q);
  if(exact) return exact;

  let starts = list.find(n => normName(n).startsWith(q));
  if(starts) return starts;

  let incl = list.find(n => normName(n).includes(q));
  if(incl) return incl;

  // 2) wenn nix: versuch in history keys (da sind evtl. andere Namen)
  const keys = Object.keys(historyByFirm||{});
  let hx = keys.find(k => k === q) || keys.find(k=>k.startsWith(q)) || keys.find(k=>k.includes(q));
  if(hx) return hx;

  return null;
}

async function doIndexSearch(){
  const input = str(indexFirmSearch.value);
  if(!input) return;

  await loadIndexHistoryOnce();

  const match = findBestFirmMatch(input);
  if(!match){
    alert("Firma nicht gefunden.");
    return;
  }

  // ‚úÖ sofort lock an (damit Hover NICHT √ºberschreibt)
  setIndexLock(true, match);

  await renderIndexForFirm(match, {keepLock:true});
  setIndexOpen(true);
}
indexFirmSearchBtn.addEventListener("click", doIndexSearch);
indexFirmSearch.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doIndexSearch(); }});

/*** ====== GEO CACHE (3 Quellen) ====== ***/
let fileGeoCache = {};
const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU")||"{}");
const saveGeo=()=>localStorage.setItem("geoCachePellets_EU",JSON.stringify(geoCache));

async function loadGeoCacheFile(){
  try{
    const r = await fetch("./geocache.json", {cache:"no-store"});
    if(!r.ok){ fileGeoCache = {}; return; }
    const j = await r.json();
    fileGeoCache = (j && typeof j === "object") ? j : {};
  }catch(e){
    fileGeoCache = {};
  }
}
function getCoordForPlace(place){
  const key = str(place);
  if(!key) return null;

  const a = fileGeoCache[key];
  if(a && isFinite(+a.lat) && isFinite(+a.lon)){
    return {lat:+a.lat, lon:+a.lon, country_code: (a.country_code||"").toLowerCase()};
  }
  const b = geoCache[key];
  if(b && isFinite(+b.lat) && isFinite(+b.lon)){
    return {lat:+b.lat, lon:+b.lon, country_code: (b.country_code||"").toLowerCase()};
  }
  return null;
}
async function geocodeOnce(q){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
    const d=await r.json(); if(!d.length) return null;
    const addr=d[0].address||{};
    const o={lat:+d[0].lat,lon:+d[0].lon,country:addr.country||"",country_code:(addr.country_code||"").toLowerCase()};
    geoCache[q]=o; saveGeo();
    return o;
  }catch(e){
    return null;
  }
}

/*** ====== ICONS ====== ***/
const tri=(fill)=>L.divIcon({
  className:"t",
  html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="${fill}" stroke="black" stroke-width="1"/></svg>`,
  iconAnchor:[12,22],popupAnchor:[0,-20]
});
const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

/*** ====== DATA CACHES ====== ***/
let werkePellets=null, werkeStreusalz=null, werke=[];
let kundenPellets=null, kundenStreusalz=null, kunden=[];
let alleMarker=[], selectedPoints=[], routeLine=null, searchMarker=null;
let ctxEl=null, ctxCustomer=null;

function closeCtx(){ if(ctxEl){ctxEl.remove(); ctxEl=null;} ctxCustomer=null; }
function stopEvt(el){
  if(!el) return;
  L.DomEvent.disableClickPropagation(el);
  L.DomEvent.disableScrollPropagation(el);
  el.addEventListener("mousedown", e=>e.stopPropagation());
  el.addEventListener("click", e=>e.stopPropagation());
  el.addEventListener("dblclick", e=>e.stopPropagation());
  el.addEventListener("contextmenu", e=>e.stopPropagation());
  el.addEventListener("wheel", e=>e.stopPropagation(), {passive:true});
  el.addEventListener("touchstart", e=>e.stopPropagation(), {passive:true});
}

/*** ====== CUSTOM FIRMS (Taste F) ====== ***/
const CUSTOM_KEY = "customFirms_EU_v1";
let customFirms = JSON.parse(localStorage.getItem(CUSTOM_KEY) || "{}");
if(!customFirms || typeof customFirms!=="object") customFirms = {};
if(!Array.isArray(customFirms.pellets)) customFirms.pellets = [];
if(!Array.isArray(customFirms.streusalz)) customFirms.streusalz = [];
const saveCustom = ()=>localStorage.setItem(CUSTOM_KEY, JSON.stringify(customFirms));

(function migrateCustomFirms(){
  let changed = false;
  for(const unit of ["pellets","streusalz"]){
    if(!Array.isArray(customFirms[unit])) continue;
    customFirms[unit] = customFirms[unit].map(f=>{
      if(!f || typeof f !== "object") return f;
      if(!f._id){ f._id = uid(); changed = true; }
      if(f._custom !== true){ f._custom = true; changed = true; }
      return f;
    });
  }
  if(changed) saveCustom();
})();

async function deleteCustomFirmById(customId){
  if(!customId) return;
  const list = customFirms[currentUnit] || [];
  customFirms[currentUnit] = list.filter(x => x && x._id !== customId);
  saveCustom();

  closeCtx();
  clearRoute();
  closeAddFirmModal();
  await switchUnit(currentUnit);
}

let modalOverlay=null, modalEl=null, modalDrag=null;
function isTypingTarget(el){
  if(!el) return false;
  const tag=(el.tagName||"").toLowerCase();
  return tag==="input" || tag==="textarea" || tag==="select" || el.isContentEditable;
}
function closeAddFirmModal(){
  if(modalEl){ modalEl.remove(); modalEl=null; }
  if(modalOverlay){ modalOverlay.remove(); modalOverlay=null; }
}
function openAddFirmModal(){
  if(modalEl) return;

  modalOverlay = document.createElement("div");
  modalOverlay.className = "modalOverlay";
  map.getContainer().appendChild(modalOverlay);
  stopEvt(modalOverlay);

  modalEl = document.createElement("div");
  modalEl.className = "modal";

  const cont = map.getContainer();
  const left = Math.max(10, (cont.clientWidth/2) - 160);
  const top  = Math.max(10, (cont.clientHeight/2) - 120);
  modalEl.style.left = left + "px";
  modalEl.style.top  = top + "px";

  modalEl.innerHTML = `
    <div class="modalHead" id="addFirmDrag">
      <div class="modalTitle">Firma hinzuf√ºgen</div>
      <button class="modalX" id="addFirmClose" type="button">√ó</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <input id="addFirmName" placeholder="Firma" autocomplete="off">
      </div>
      <div class="row">
        <input id="addFirmOrt" placeholder="Ort" autocomplete="off">
      </div>
      <div class="row">
        <input id="addFirmPreis" type="number" step="0.01" placeholder="Preis (‚Ç¨)" autocomplete="off">
      </div>
      <div class="btnRow">
        <button class="btn" id="addFirmSave" type="button">Speichern</button>
        <button class="btn" id="addFirmCancel" type="button">Abbrechen</button>
      </div>
    </div>
  `;
  map.getContainer().appendChild(modalEl);
  stopEvt(modalEl);

  modalEl.querySelector("#addFirmClose").addEventListener("click", closeAddFirmModal);
  modalEl.querySelector("#addFirmCancel").addEventListener("click", closeAddFirmModal);

  const nameEl = modalEl.querySelector("#addFirmName");
  const ortEl  = modalEl.querySelector("#addFirmOrt");
  const preisEl= modalEl.querySelector("#addFirmPreis");

  modalEl.querySelector("#addFirmSave").addEventListener("click", async ()=>{
    const firma = str(nameEl.value);
    const ort   = str(ortEl.value);
    const preis = num(preisEl.value);

    if(!firma || !ort || !isFinite(preis) || preis<=0){
      alert("Bitte Firma, Ort und Preis korrekt eingeben.");
      return;
    }

    let c = getCoordForPlace(ort);
    if(!c){
      const g = await geocodeOnce(ort);
      if(!g){ alert("Ort nicht gefunden."); return; }
      c = { lat:g.lat, lon:g.lon, country_code:g.country_code||"" };
    }

    const obj = {
      _id: uid(),
      firma, ort,
      preis, preisSack: NaN,
      stand: "",
      zert:"", sack:"", bigbag:"",
      _preisOrig: preis, _preisSackOrig: NaN,
      keinPreisWerk:false, keinPreisSack:true,
      farbeWerk: colorForPrice(preis,false),
      farbeSack: "#9e9e9e",
      _coord: {lat:c.lat, lon:c.lon},
      country_code: (c.country_code||"").toLowerCase(),
      _custom: true
    };

    customFirms[currentUnit].push(obj);
    saveCustom();

    addFirmMarker(obj);
    updateLayers();
    closeAddFirmModal();
  });

  modalDrag = modalEl.querySelector("#addFirmDrag");
  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  modalDrag.addEventListener("mousedown",(e)=>{
    dragging=true;
    sx=e.clientX; sy=e.clientY;
    const r=modalEl.getBoundingClientRect();
    const cr=map.getContainer().getBoundingClientRect();
    ox=r.left-cr.left; oy=r.top-cr.top;
    e.preventDefault();
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging || !modalEl) return;
    const cr=map.getContainer().getBoundingClientRect();
    let nx = ox + (e.clientX - sx);
    let ny = oy + (e.clientY - sy);
    nx = Math.min(Math.max(10, nx), cr.width-340);
    ny = Math.min(Math.max(10, ny), cr.height-220);
    modalEl.style.left = nx+"px";
    modalEl.style.top  = ny+"px";
  });
  window.addEventListener("mouseup",()=>dragging=false);

  setTimeout(()=>nameEl.focus(),0);
}

/*** ====== PARSER ====== ***/
function findIndex(headers, cands){
  const hs=headers.map(h=>lc(h));
  const cs=cands.map(c=>lc(c));
  return hs.findIndex(h=>cs.includes(h));
}

function parseFirmenArray(table){
  if(!table || table.length<2) return [];
  const headers=(table[0]||[]).map(x=>str(x));
  const rows=table.slice(1);

  let nameIdx = findIndex(headers, ["firma","name","werk"]); if(nameIdx<0) nameIdx = 0;
  let ortIdx  = findIndex(headers, ["ort","stadt","standort","adresse","location"]); if(ortIdx<0) ortIdx = 1;

  const preisIdx = 2;   // Spalte C
  const standIdx = 3;   // Spalte D

  let sackIdx = findIndex(headers, ["sackwarenpreis","sackwarepreis","preis_sack","sackpreis","preis sack"]);
  if(sackIdx<0) sackIdx = 4;

  let zertIdx = findIndex(headers, ["zertifikat","zertifikate","zert","cert"]); if(zertIdx<0) zertIdx = -1;
  let sackTxtIdx = findIndex(headers, ["sackware","sack","bag","bagged"]); if(sackTxtIdx<0) sackTxtIdx = -1;

  let bigBagIdx = findIndex(headers, ["big bag","bigbag","big_bag","big-bag"]);
  if(bigBagIdx<0 && headers.length>=13) bigBagIdx = 12;

  return rows
    .filter(r=>str(r[nameIdx]) && str(r[ortIdx]))
    .map(r=>{
      const p = num(r[preisIdx]);
      const ps = num(r[sackIdx]);
      const st = str(r[standIdx]);

      return {
        firma: str(r[nameIdx]),
        ort: str(r[ortIdx]),
        preis: p,
        preisSack: ps,
        stand: st,
        zert: zertIdx>=0 ? str(r[zertIdx]) : "",
        sack: sackTxtIdx>=0 ? str(r[sackTxtIdx]) : "",
        bigbag: bigBagIdx>=0 ? str(r[bigBagIdx]) : "",
        _preisOrig: p,
        _preisSackOrig: ps
      };
    });
}

function parseKunden(rows){
  const keys=Object.keys(rows[0]||{}),
    nameKey=(keys.find(k=>["name","kunde","kundenname"].includes(lc(k)))||keys[0]),
    ortKey=(keys.find(k=>["ort","adresse","standort","anschrift","stadt","location"].includes(lc(k)))||keys[1]),
    loseKey=(keys.find(k=>lc(k)==="lose")||"lose"),
    sackKey=(keys.find(k=>lc(k)==="sackware")||"sackware"),
    sonstKey=(keys.find(k=>lc(k)==="sonstige")||"sonstige");

  return rows.map(x=>({
    name:str(x[nameKey]),
    ort:str(x[ortKey]),
    lose:lc(x[loseKey]),
    sackware:lc(x[sackKey]),
    sonstige:lc(x[sonstKey])
  })).filter(x=>x.name&&x.ort);
}

function normalizePreise(d){
  const w=d.filter(x=>isFinite(x.preis)&&x.preis>0);
  const s=d.filter(x=>isFinite(x.preisSack)&&x.preisSack>0);
  const avgW=w.length?w.reduce((a,b)=>a+b.preis,0)/w.length:0;
  const avgS=s.length?s.reduce((a,b)=>a+b.preisSack,0)/s.length:0;

  return d.map(x=>{
    x.keinPreisWerk = !(isFinite(x._preisOrig) && x._preisOrig>0);
    x.keinPreisSack = !(isFinite(x._preisSackOrig) && x._preisSackOrig>0);

    if(x.keinPreisWerk) x.preis = avgW;
    if(x.keinPreisSack) x.preisSack = avgS;

    x.farbeWerk = colorForPrice(x._preisOrig, x.keinPreisWerk);
    x.farbeSack = colorForPrice(x._preisSackOrig, x.keinPreisSack);
    return x;
  });
}

/*** ====== LOADERS ====== ***/
async function loadWerkeForUnit(unit){
  if(unit==="pellets" && werkePellets) return werkePellets;
  if(unit==="streusalz" && werkeStreusalz) return werkeStreusalz;

  const url = (unit==="pellets") ? sheetUrlFirmenPellets : sheetUrlFirmenStreusalz;

  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:false, skipEmptyLines:true,
    complete:r=>{ try{ res(normalizePreise(parseFirmenArray(r.data||[]))) }catch(e){ res([]) } },
    error:_=>res([])
  }));

  if(unit==="pellets") werkePellets = data;
  else werkeStreusalz = data;
  return data;
}

async function loadKundenForUnit(unit){
  if(unit==="pellets" && kundenPellets) return kundenPellets;
  if(unit==="streusalz" && kundenStreusalz) return kundenStreusalz;

  const url = (unit==="pellets") ? sheetUrlKundenPellets : sheetUrlKundenStreusalz;

  const data = await new Promise(res=>Papa.parse(url,{
    download:true, header:true, skipEmptyLines:true,
    complete:r=>{ try{ res(parseKunden(r.data||[])) }catch(e){ res([]) } },
    error:_=>res([])
  }));

  if(unit==="pellets") kundenPellets = data;
  else kundenStreusalz = data;
  return data;
}

/*** ====== COUNTRY ====== ***/
function getSelectedCountries(){
  const s=[...document.querySelectorAll(".countryChk")].filter(c=>c.checked).map(c=>c.value);
  return (!s.length||s.includes("all"))?["all"]:s;
}
function updateCountryButtonLabel(){
  const s=getSelectedCountries();
  if(s.length===1&&s[0]==="all") return countryDropdownBtn.textContent="Alle L√§nder";
  const names={be:"BE",dk:"DK",de:"DE",ee:"EE",fi:"FI",fr:"FR",it:"IT",lv:"LV",lt:"LT",nl:"NL",at:"AT",pl:"PL",se:"SE",ch:"CH",sk:"SK",cz:"CZ",gb:"UK"};
  countryDropdownBtn.textContent=s.map(c=>names[c]||c.toUpperCase()).join(", ");
}

/*** ====== TOOLTIP (Stand hinter Preis) ====== ***/
function tooltipFirma(m){
  const {price, isManual} = getEffectiveFirmPrice(m);
  const preisTxt = (isFinite(price) && price>0) ? `${price.toFixed(2)} ‚Ç¨` : "‚Äì";
  const standTxt = (str(m.stand)) ? ` (${str(m.stand)})` : "";
  const manTxt = isManual ? `<br><span class="small"><b>Manuell:</b> ${price.toFixed(2)} ‚Ç¨</span>` : "";
  const z=m.zert?`<br><b>Zertifikat:</b> ${m.zert}`:"";
  const s=(isPellets() && m.sack)?`<br><b>Sackware:</b> ${m.sack}`:"";
  const bb=(isPellets() && lc(m.bigbag)==="ja")?`<br><b>Sackware:</b> Big Bag`:"";
  return `<b>${m.firma}</b><br>${m.ort}<br>${preisTxt}${standTxt}${manTxt}${z}${s}${bb}`;
}

/*** ====== FIRMA-POPUP (RECHTSKLICK) ====== ***/
let activeFirmForPricePopup = null;

window.saveManualFirmPrice = function(){
  if(!activeFirmForPricePopup) return;
  const inp = document.getElementById("manualFirmPriceInput");
  const v = num(inp ? inp.value : "");
  if(!isFinite(v) || v<=0){ alert("Bitte g√ºltigen Preis eingeben."); return; }
  setManualPriceForFirm(activeFirmForPricePopup, v);
  map.closePopup();
  updateLayers();
};
window.clearManualFirmPrice = function(){
  if(!activeFirmForPricePopup) return;
  setManualPriceForFirm(activeFirmForPricePopup, NaN);
  map.closePopup();
  updateLayers();
};

function openFirmPricePopup(firmObj, latlng){
  activeFirmForPricePopup = firmObj.firma;

  const isSack = isPellets() && sackAktiv();
  const baseOrig = isSack ? firmObj._preisSackOrig : firmObj._preisOrig;
  const baseTxt = (isFinite(baseOrig) && baseOrig>0) ? baseOrig.toFixed(2) : "‚Äì";

  const manual = getManualPriceForFirm(firmObj.firma);
  const manualTxt = manual ? manual.toFixed(2) : "";

  const label = !isPellets()
    ? "Werkspreis (Streusalz)"
    : (isSack ? "Sackware-Preis" : "Werkspreis (Lose)");

  const html = `
    <div style="min-width:240px">
      <b>${firmObj.firma}</b><br>
      <div class="small">${firmObj.ort}</div>
      <div style="margin-top:6px" class="small"><b>Tabellen ${label}:</b> ${baseTxt} ‚Ç¨</div>

      <div style="margin-top:10px"><b>Preis manuell setzen</b></div>
      <input id="manualFirmPriceInput" type="number" step="0.01" placeholder="‚Ç¨/t" value="${manualTxt}"
             style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;outline:none">

      <div class="btnRow">
        <button class="btn" onclick="saveManualFirmPrice()">Speichern</button>
        <button class="btn" onclick="clearManualFirmPrice()">L√∂schen</button>
      </div>
    </div>
  `;

  L.popup({closeButton:true, autoPan:true})
    .setLatLng(latlng)
    .setContent(html)
    .openOn(map);

  setTimeout(()=>{
    const el=document.getElementById("manualFirmPriceInput");
    if(el) el.focus();
  }, 0);
}

/*** ====== MARKER HELPERS ====== ***/
function addFirmMarker(w){
  const c = (w && w._coord && isFinite(+w._coord.lat) && isFinite(+w._coord.lon))
    ? {lat:+w._coord.lat, lon:+w._coord.lon, country_code:(w.country_code||"").toLowerCase()}
    : getCoordForPlace(w.ort);

  if(!c) return null;

  const farbe = getEffectiveFirmColor(w);

  const cm=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:.85})
    .bindTooltip("",{sticky:true})
    .on("tooltipopen", async ()=>{
      cm.getTooltip().setContent(tooltipFirma({...w,country_code:c.country_code}));

      // ‚úÖ wenn gelockt ‚Üí Hover darf NICHT √§ndern
      if(indexLocked) return;

      await renderIndexForFirm(w.firma, {keepLock:true});
    })
    .on("click",()=>pickPoint(w.firma,{lat:c.lat,lon:c.lon}))
    .on("contextmenu",(ev)=>{
      ev.originalEvent?.preventDefault?.();
      openFirmPricePopup(w, ev.latlng);
    })
    .on("mousedown", async (ev)=>{
      const btn = ev?.originalEvent?.button;
      if(btn !== 1) return;
      if(!(w && w._custom && w._id)) return;
      ev.originalEvent?.preventDefault?.();
      await deleteCustomFirmById(w._id);
    });

  const entry = {type:"firma",marker:cm,...w,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}};
  alleMarker.push(entry);
  return entry;
}

function addCustomerMarker(k){
  const c = getCoordForPlace(k.ort);
  if(!c) return null;

  let type="kunde", icon=iconBlue;
  if(isPellets()){
    const isSackOnly=(k.sackware==="ja")&&(k.lose!=="ja");
    const isSonstige=(k.sonstige==="ja");
    type=isSonstige?"sonstige":isSackOnly?"sackkunde":"kunde";
    icon=isSonstige?iconOrange:isSackOnly?iconPurple:iconBlue;
  }else{
    type="streukunde";
    icon=iconBlue;
  }

  const mk=L.marker([c.lat,c.lon],{icon})
    .bindTooltip(`<b>${k.name}</b><br>${k.ort}`,{sticky:true})
    .on("click",()=>pickPoint(k.name,{lat:c.lat,lon:c.lon}))
    .on("contextmenu",(e)=>{
      e.originalEvent?.preventDefault?.();
      openCustomerMenu(k,{lat:c.lat,lon:c.lon},e.originalEvent);
    });

  const entry = {type,marker:mk,...k,country_code:c.country_code||"", _coord:{lat:c.lat,lon:c.lon}};
  alleMarker.push(entry);
  return entry;
}

/*** ====== BUILD MAP ====== ***/
async function buildMap(){
  const myToken = ++buildToken;

  for(const m of alleMarker){ try{ map.removeLayer(m.marker); }catch(e){} }
  alleMarker=[];

  const bounds=L.latLngBounds();

  for(const w of werke){
    if(myToken !== buildToken) return;
    const added = addFirmMarker(w);
    if(added) bounds.extend([added._coord.lat, added._coord.lon]);
  }

  for(const k of kunden){
    if(myToken !== buildToken) return;
    const added = addCustomerMarker(k);
    if(added) bounds.extend([added._coord.lat, added._coord.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.15));
  updateLayers();
}

/*** ===== ROUTE / PRICE ===== */
function luftlinieKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon), la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}
async function osrmDistKm(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
  const res=await fetch(url);
  const data=res.ok?await res.json():null;
  if(data?.routes?.length) return data.routes[0].distance/1000;
  return null;
}
function calcDeliveredPrice(distKm, basePrice){
  const preisProKm = distKm < 250 ? 2.15 : 1.85;
  const berechnung = (distKm/24) * preisProKm;
  const margeFaktor = (currentUnit === "streusalz") ? 1.20 : 1.05;
  const total = (berechnung + (basePrice||0)) * margeFaktor;
  return { total, preisProKm, margeFaktor };
}
function findFirmInLabels(aLabel,bLabel){
  return werke.find(w=>w.firma===aLabel) || werke.find(w=>w.firma===bLabel) || null;
}
function getBasePriceForFirm(firmObj){
  if(!firmObj) return 0;

  const manual = getManualPriceForFirm(firmObj.firma);
  if(manual) return manual;

  const isSack = isPellets() && sackAktiv();
  const base = isSack ? firmObj.preisSack : firmObj.preis;
  return base || 0;
}
async function showRouteByCoords(aLabel,aCoord,bLabel,bCoord){
  const osrm=`https://router.project-osrm.org/route/v1/driving/${aCoord.lon},${aCoord.lat};${bCoord.lon},${bCoord.lat}?overview=full&geometries=geojson`;
  let distKm=null, coords=null, dashed=false, durStr="";
  try{
    const res=await fetch(osrm);
    const data=res.ok?await res.json():null;
    if(data?.routes?.length){
      const r=data.routes[0];
      distKm=r.distance/1000;
      const min=r.duration/60, h=Math.floor(min/60), m=Math.round(min%60);
      durStr=h?`${h}h ${m}min`:`${m}min`;
      coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
    }
  }catch(e){}
  if(!distKm){
    distKm=luftlinieKm(aCoord,bCoord);
    coords=[[aCoord.lat,aCoord.lon],[bCoord.lat,bCoord.lon]];
    dashed=true;
  }

  const firmObj = findFirmInLabels(aLabel,bLabel);
  const base = getBasePriceForFirm(firmObj);
  const {total, preisProKm, margeFaktor} = calcDeliveredPrice(distKm, base);

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:"blue",weight:5,opacity:.85,dashArray:dashed?"8 8":null}).addTo(map);
  const mid=coords[Math.floor(coords.length/2)];
  const margeTxt = (margeFaktor===1.20) ? "20%" : "5%";

  const baseLabel = (currentUnit==="streusalz")
    ? "Werkspreis"
    : ((isPellets() && sackAktiv()) ? "Sackware-Preis" : "Werkspreis");

  L.popup().setLatLng(mid).setContent(`
    <b>Route:</b> ${aLabel} ‚Üî ${bLabel}<br>
    <b>Entfernung:</b> ${distKm.toFixed(1)} km ${dashed?"(Luftlinie)":"(Stra√üe)"}<br>
    ${durStr?`<b>Dauer:</b> ${durStr}<br>`:""}
    <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
    <b>${baseLabel}:</b> ${(base||0).toFixed(2)} ‚Ç¨<br>
    <b>Marge:</b> ${margeTxt}<br>
    <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${total.toFixed(2)} ‚Ç¨</span>
    ${dashed?`<br><small>Keine Stra√üenroute verf√ºgbar ‚Üí Luftlinie gestrichelt.</small>`:""}
  `).openOn(map);

  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}
function showRoute(a,b){ return showRouteByCoords(a.label, a.coord, b.label, b.coord); }

/*** ===== PICK / CLEAR ===== */
function pickPoint(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    selectedPoints=[];
    showRoute(a,b);
  }
}
function clearRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
  map.closePopup();
  selectedPoints = [];
}

/*** ===== CONTEXT MENU (Zielpreis) ===== */
function openCustomerMenu(kunde, coord, mouseEvent){
  closeCtx();
  ctxCustomer = {name:kunde.name, ort:kunde.ort, coord};

  const p = map.mouseEventToContainerPoint(mouseEvent);
  const cont = map.getContainer();

  ctxEl = document.createElement("div");
  ctxEl.className = "ctxbox";
  ctxEl.style.left = Math.min(Math.max(10, p.x), cont.clientWidth-300) + "px";
  ctxEl.style.top  = Math.min(Math.max(10, p.y), cont.clientHeight-320) + "px";

  const typeRow = isPellets() ? `
    <div class="row" style="margin-top:10px">
      <select id="ctxType">
        <option value="lose">Pellets lose</option>
        <option value="sack">Sackware</option>
        <option value="bigbag">Big Bag</option>
      </select>
    </div>
  ` : `
    <div class="row" style="margin-top:10px">
      <div class="small"><b>Unit:</b> Streusalz</div>
    </div>
  `;

  ctxEl.innerHTML = `
    <div class="topbar">
      <div style="min-width:0">
        <b style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.name}</b>
        <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${kunde.ort}</div>
      </div>
      <button class="xbtn" id="ctxClose">√ó</button>
    </div>

    ${typeRow}

    <div class="row">
      <input id="ctxPrice" type="number" step="0.01" placeholder="Zielpreis (‚Ç¨)">
    </div>

    <div class="results" id="ctxResults"></div>
  `;

  cont.appendChild(ctxEl);
  stopEvt(ctxEl);

  ctxEl.querySelector("#ctxClose").addEventListener("click", closeCtx);

  const input = ctxEl.querySelector("#ctxPrice");
  input.focus();
  input.addEventListener("keydown", async (e)=>{
    if(e.key !== "Enter") return;
    const target = num(input.value);
    const type = isPellets() ? (ctxEl.querySelector("#ctxType").value) : "lose";
    if(!isFinite(target) || target<=0){ alert("Bitte einen g√ºltigen Zielpreis eingeben."); return; }
    await runTargetSearch(type, target);
  });
}

async function runTargetSearch(type, targetPrice){
  if(!ctxEl || !ctxCustomer) return;
  const resBox = ctxEl.querySelector("#ctxResults");
  resBox.innerHTML = `<div class="small">Suche‚Ä¶</div>`;

  let firmsVisible = alleMarker
    .filter(m => m.type==="firma" && map.hasLayer(m.marker))
    .map(m => {
      const isSack = isPellets() && (type === "sack" || type === "bigbag");

      const key = `${currentUnit}|${isSack?"sack":"lose"}|${str(m.firma)}`;
      const manual = (isFinite(+manualPrices[key]) && +manualPrices[key]>0) ? +manualPrices[key] : null;

      const hasReal = manual ? true : (isSack ? !m.keinPreisSack : !m.keinPreisWerk);
      const base = manual ?? (isSack ? m._preisSackOrig : m._preisOrig);

      return { ...m, base, hasReal };
    })
    .filter(m => m.hasReal && isFinite(m.base) && m.base>0);

  if (isPellets() && type === "bigbag") {
    firmsVisible = firmsVisible.filter(m => lc(m.bigbag) === "ja");
  }

  if(!firmsVisible.length){
    resBox.innerHTML = `<div class="small">Keine passenden Firmen mit Preis gefunden.</div>`;
    return;
  }

  const c = ctxCustomer.coord;

  const pre = firmsVisible.map(f=>{
    const d0 = luftlinieKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon});
    return {...f, d0};
  }).sort((a,b)=>a.d0-b.d0);

  const LIMIT = 40;
  const candidates = pre.slice(0, Math.min(LIMIT, pre.length));

  const matches = [];
  for(const f of candidates){
    let dist = null;
    try{ dist = await osrmDistKm({lat:c.lat,lon:c.lon},{lat:f._coord.lat,lon:f._coord.lon}); }catch(e){}
    if(!dist) dist = f.d0;
    const {total} = calcDeliveredPrice(dist, f.base);
    if(total <= targetPrice) matches.push({ f, distKm: dist, total });
  }

  matches.sort((a,b)=>a.total-b.total);

  if(!matches.length){
    resBox.innerHTML = `<div class="small">Keine Firma unter ${targetPrice.toFixed(2)} ‚Ç¨ gefunden.</div>`;
    return;
  }

  const pill = isPellets()
    ? (type==="bigbag" ? "Big Bag" : (type==="sack" ? "Sackware" : "Lose"))
    : "Streusalz";

  const baseLabel = isPellets()
    ? ((type==="sack" || type==="bigbag") ? "Sackware-Preis" : "Werkspreis")
    : "Werkspreis";

  resBox.innerHTML = matches.slice(0,20).map((m,i)=>`
    <div class="item" data-i="${i}">
      <div><b>${m.f.firma}</b><span class="pill">${pill}</span></div>
      <div class="small">${m.f.ort}</div>
      <div class="small"><b>Entfernung:</b> ${m.distKm.toFixed(1)} km</div>
      <div class="small"><b>${baseLabel}:</b> ${m.f.base.toFixed(2)} ‚Ç¨</div>
      <div><b>Lieferpreis:</b> ${m.total.toFixed(2)} ‚Ç¨</div>
    </div>
  `).join("");
}

/*** ===== LAYERS ===== */
function updateLayers(){
  if(routeLine){map.removeLayer(routeLine);routeLine=null}
  selectedPoints=[];

  const selected=getSelectedCountries(), noCountry=(selected.length===1&&selected[0]==="all");
  const en=chkEnPlus.checked, din=chkDINplus.checked, sure=chkSURE.checked, cpp=chkCPP.checked, ohne=chkOhneZert.checked;
  const gr=chkGruen.checked, or=chkOrange.checked, ro=chkRot.checked, ga=chkGrau.checked;

  const wantF = isPellets() ? chkSackFireflies.checked : false;
  const want15 = isPellets() ? chkSack15kg.checked : false;
  const wantBB = isPellets() ? chkBigBag.checked : false;
  const useSack = isPellets() && (wantF || want15 || wantBB);

  const showPelletK = isPellets() ? chkKunden.checked : false;
  const showPelletSK = isPellets() ? chkSackKunden.checked : false;
  const showPelletS = isPellets() ? chkSonstigeKunden.checked : false;
  const showStreuK = !isPellets() ? chkKundenStreusalz.checked : false;

  for(const m of alleMarker){
    if(map.hasLayer(m.marker)) map.removeLayer(m.marker);

    if(!noCountry && m.country_code && !selected.includes(m.country_code)) continue;

    if(m.type==="kunde"){ if(showPelletK) map.addLayer(m.marker); continue; }
    if(m.type==="sackkunde"){ if(showPelletSK) map.addLayer(m.marker); continue; }
    if(m.type==="sonstige"){ if(showPelletS) map.addLayer(m.marker); continue; }
    if(m.type==="streukunde"){ if(showStreuK) map.addLayer(m.marker); continue; }

    if(useSack){
      const s=lc(m.sack).replace(/\s+/g," ");
      const hasF=s.includes("fireflies");
      const has15=s.includes("15 kg")||s.includes("15kg");
      const hasBB=lc(m.bigbag)==="ja";
      const anyMatch = (wantF && hasF) || (want15 && has15) || (wantBB && hasBB);
      if(!anyMatch) continue;
    }

    const z=lc(m.zert);
    let zertOK=false;
    if(z.includes("enplus")&&en) zertOK=true;
    if(z.includes("dinplus")&&din) zertOK=true;
    if(z.includes("sure")&&sure) zertOK=true;
    if(z.includes("cpp")&&cpp) zertOK=true;
    if(!z&&ohne) zertOK=true;
    if(!zertOK) continue;

    const farbe = getEffectiveFirmColor(m);
    const ok=(farbe==="green"&&gr)||(farbe==="orange"&&or)||(farbe==="red"&&ro)||(farbe==="#9e9e9e"&&ga);
    if(!ok) continue;

    m.marker.setStyle?.({color:farbe,fillColor:farbe});
    map.addLayer(m.marker);
  }
}

/*** ===== UNIT UI ===== */
function applyUnitUIOnly(){
  if(isPellets()){
    certTitle.textContent = "Zertifikate & Sackware";
    sackSection.classList.remove("hidden");
    kundenFilterPellets.classList.remove("hidden");
    kundenFilterStreusalz.classList.add("hidden");
  }else{
    certTitle.textContent = "Zertifikate";
    sackSection.classList.add("hidden");
    kundenFilterPellets.classList.add("hidden");
    kundenFilterStreusalz.classList.remove("hidden");
    chkSackFireflies.checked = false;
    chkSack15kg.checked = false;
    chkBigBag.checked = false;
  }
  refreshLegendThresholdUI();
}

/*** ===== UNIT SWITCH ===== */
async function switchUnit(newUnit){
  currentUnit = newUnit;
  applyUnitUIOnly();
  closeCtx();
  clearRoute();
  closeAddFirmModal();

  // ‚úÖ beim Unit-Wechsel: Index Lock aus (sonst verwirrend)
  setIndexLock(false, null);

  const baseWerke = await loadWerkeForUnit(currentUnit);
  const extra = (customFirms[currentUnit] || []);
  werke = baseWerke.concat(extra);

  kunden = await loadKundenForUnit(currentUnit);

  await buildMap();
}
unitSelect.addEventListener("change", async ()=>{ await switchUnit(unitSelect.value); });

/*** ===== EVENTS ===== */
map.on("click", (e)=>{
  if(ctxEl) return;

  if(routeLine){
    const t = e.originalEvent?.target;
    if(t && (t.tagName === "path" || t.closest?.("path"))) return;
    clearRoute();
    return;
  }
});

document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeAddFirmModal();
    clearRoute();
    closeCtx();
    setIndexLock(false, null);
    if(activeIndexFirm) renderIndexForFirm(activeIndexFirm, {keepLock:true});
  }
});

document.addEventListener("mousedown",(e)=>{
  if(!ctxEl) return;
  if(ctxEl.contains(e.target)) return;
  closeCtx();
});
map.on("movestart", closeCtx);
map.on("zoomstart", closeCtx);

function clampThresholdsFromInputs(){
  let g = num(thGreen.value);
  let o = num(thOrange.value);
  if(!isFinite(g) || g<=0) g = 260;
  if(!isFinite(o) || o<=0) o = 285;
  if(o <= g) o = g + 1;
  setThresholds(g, o);
  refreshLegendThresholdUI();
  updateLayers();
}
thGreen.addEventListener("change", clampThresholdsFromInputs);
thOrange.addEventListener("change", clampThresholdsFromInputs);
thGreen.addEventListener("keydown",(e)=>{ if(e.key==="Enter") { e.preventDefault(); clampThresholdsFromInputs(); } });
thOrange.addEventListener("keydown",(e)=>{ if(e.key==="Enter") { e.preventDefault(); clampThresholdsFromInputs(); } });

document.addEventListener("change",e=>{
  if(e.target?.matches('input[type="checkbox"]')){
    if(e.target.classList.contains("countryChk")){
      if(e.target.value==="all"&&e.target.checked) [...document.querySelectorAll(".countryChk")].forEach(x=>x.value!=="all"&&(x.checked=false));
      if(e.target.value!=="all"&&e.target.checked) document.querySelector('.countryChk[value="all"]').checked=false;
      updateCountryButtonLabel();
    }

    if(e.target===chkSackFireflies || e.target===chkSack15kg || e.target===chkBigBag){
      refreshLegendThresholdUI();
    }

    updateLayers();
  }
});

countryDropdownBtn.addEventListener("click",()=>countryDropdownMenu.style.display=(countryDropdownMenu.style.display==="block"?"none":"block"));
document.addEventListener("click",e=>{if(!countryDropdown.contains(e.target)) countryDropdownMenu.style.display="none"});

/*** ===== KEY: F -> Firma hinzuf√ºgen ===== */
document.addEventListener("keydown",(e)=>{
  if(e.key==="F" || e.key==="f"){
    if(isTypingTarget(document.activeElement)) return;
    openAddFirmModal();
  }
});

/*** ===== SEARCH (Nominatim nur hier) ===== */
searchInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const raw=e.target.value.trim(); if(!raw) return;

  closeCtx();
  clearRoute();
  closeAddFirmModal();

  if(searchMarker){ try{ map.removeLayer(searchMarker); }catch(err){} searchMarker=null; }

  const q=lc(raw);
  const matches=alleMarker.filter(m=>{
    const name=lc(m.firma||m.name), ort=lc(m.ort);
    return name.includes(q)||ort.includes(q);
  });

  const bounds=L.latLngBounds();
  matches.forEach((m,i)=>{
    if(!map.hasLayer(m.marker)) map.addLayer(m.marker);
    bounds.extend(m.marker.getLatLng());
    if(i===0) m.marker.openTooltip?.();
  });

  const geo = await geocodeOnce(raw);
  if(geo){
    const ll=[geo.lat,geo.lon];
    const coordObj = {lat: geo.lat, lon: geo.lon};

    searchMarker=L.circleMarker(ll,{radius:8,color:"blue",fillColor:"blue",fillOpacity:.5}).addTo(map);
    searchMarker.bindTooltip(`<b>${raw}</b>`,{sticky:true});

    searchMarker.on("contextmenu",(ev)=>{
      ev.originalEvent?.preventDefault?.();
      openCustomerMenu({ name: raw, ort: geo.country || raw }, coordObj, ev.originalEvent);
    });

    bounds.extend(ll);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(.2));
  else alert("Kein Treffer gefunden.");
});

/*** ===== INIT ===== */
(async()=>{
  updateCountryButtonLabel();
  applyUnitUIOnly();

  await loadGeoCacheFile();
  refreshLegendThresholdUI();

  ensureIndexChart();

  setIndexLock(false, null);

  await switchUnit(unitSelect.value);
})();
</script>
</body>
</html>
